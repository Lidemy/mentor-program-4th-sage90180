<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Board</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.1/css/bootstrap.min.css"
    integrity="sha384-VCmXjywReHh4PwowAiWNagnWcLhlEJLA5buUprzK8rxFgeH0kww/aWY76TfkUoSX" crossorigin="anonymous">
  <script src="https://kit.fontawesome.com/4f39c4000d.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="css/board.css">
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light">
    <a class="navbar-brand" href="#">Hello Board</a>
    <div class="navbar-toggler" data-toggle="collapse" data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-hamburger"></i>
    </div>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto align-items-center">
        <li class="nav-item active d-flex align-items-center">
          <a class="nav-link" href="#">Todos</a>
        </li>
        <li class="nav-item d-flex align-items-center">
          <a class="nav-link" href="#">Board</a>
        </li>
      </ul>
    </div>
  </nav>
  <div class="board-wrap mb-3">
    <div class="container board">
      <div class="row mt-4 text-center justify-content-center board-header">
        Hello Board
      </div>
      <div class="col-12 board-alert">
        <div class="alert text-center col-12 board-alert" role="alert">
          <i class="fas fa-exclamation-triangle"></i> 請輸入內容
        </div>
      </div>
      <form class="row board-form pt-4 pb-2" method="POST" action="./api_add_comments.php">
        <div class="col-12 col-sm-12">
          <div class="form-group">
            <textarea type="text" name="content" rows="3" placeholder="請輸入留言" class="form-control"></textarea>
          </div>
        </div>
        <div class="col-12 col-sm-8">
          <div class="form-group">
            <input type="text" name="nickname" placeholder="請輸入暱稱" class="form-control">
          </div>
        </div>
        <div class="col-12 col-sm-4">
          <button type="submit" class="btn btn-block board-add-btn"><i class="fas fa-plus mr-2"></i>新增</button>
        </div>
      </form>
      <div class="row board-list">
      </div>
      <div class="row board-footer justify-content-center text-center">

      </div>
    </div>
  </div>


  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.1/js/bootstrap.min.js"
    integrity="sha384-XEerZL0cuoUbHE4nZReLT7nx9gQrQreJekYhJD9WNWhH8nEW+0c5qq7aIo2Wl30J" crossorigin="anonymous">
  </script>


  <script>
    // 時間格式 yyyy-mm-dd hh:mm:ss
    function getTime() {
      var now = new Date();
      var year = now.getFullYear(); //yyyy
      var month = now.getMonth() + 1; //mm
      var day = now.getDate(); //dd
      var hh = now.getHours(); //hh
      var mm = now.getMinutes(); //mm
      var ss = now.getSeconds(); //ss
      var clock = year + "-";
      if (month < 10)
        clock += "0";
      clock += month + "-";
      if (day < 10)
        clock += "0";
      clock += day + " ";
      if (hh < 10)
        clock += "0";
      clock += hh + ":";
      if (mm < 10) 
      clock += '0';
      clock += mm+ ":";
      if (ss < 10) 
      clock += '0';
      clock += ss;
      return clock
    }

    function escape(s) {
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
    }

    function appendCommentToDom(container, comment, isPrepend) {
      const html = `
        <div class="col-12 board-list-group">
          <div class="row board-list-group-item d-flex justify-content-between align-items-start pb-3 pt-3">
            <div class="col-md-8 col-12 pb-2 d-flex align-items-center board-list-name">
              <span class="badge mr-2">訪客</span>${escape(comment.nickname)}
            </div>
            <div class="board-list-date col-md-4 col-12 text-right pb-2">
              ${comment.created_at}
            </div>
            <div class="col-12 board-list-message">
              ${escape(comment.content)}
            </div>
          </div>
        </div>
      `
      if (isPrepend) {
        container.prepend(html)
      } else {
        container.append(html)
      }

    }

    const limit = 5

    function getCommentsAPI(siteKey, before, cb) {
      let url = `http://localhost:8080/api_board/api_comments.php?site_key=${siteKey}&limit=${limit}`
      if(before) {
        url += '&before=' + before
      }
      $.ajax({
        url,
      }).done(data => {
        cb(data)
      });
    }

    const siteKey = '12345'
    const loadMoreBtnHTML = `
      <div class="board-footer-more col-md-2 col-sm-3 col-12">
        載入更多 <i class="fas fa-arrow-circle-down"></i>
      </div>
    `
    let lastId = null
    let isEnd = false
    const commentDom = $('.board-list')

    function getComments(){
      $('.board-footer-more').hide()
      if(isEnd){
        return
      }
      getCommentsAPI(siteKey, lastId, data => {
        if (!data.ok) {
          alert(data.message)
          return
        }
        const comments = data.discussions
        for (let comment of comments) {
          appendCommentToDom(commentDom, comment)
        }
        let length = comments.length
        if(length < limit){
          isEnd = true
          $('.board-footer-more').hide()
        } else {
          lastId = comments[length-1].id
          $('.board-footer').append(loadMoreBtnHTML)
        }
      })
    }

    $(document).ready(() => {
      getComments()
      $('.board-footer').on('click','.board-footer-more',()=>{
        getComments()
      })
      
      $('.board-form').submit((e) => {
        console.log(getTime())
        e.preventDefault();
        const newCommentData = {
          'site_key': '12345',
          'nickname': $('input[name=nickname]').val(),
          'content': $('textarea[name=content]').val(),
          'created_at': getTime()
        }
        $.ajax({
          type: 'POST',
          url: 'http://localhost:8080/api_board/api_add_comments.php',
          data: newCommentData,
          success: resp => {
            if (!resp.ok) {
              $('.alert').fadeIn()
              return
            }
            $('input[name=nickname]').val('')
            $('textarea[name=content]').val('')

            appendCommentToDom(commentDom, newCommentData, true)
          }
        })
      })
    })
  </script>


</body>

</html>